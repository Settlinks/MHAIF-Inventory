<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Inventory | Secure Portal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.css">
    <style>
        :root { --brand-color: #0056b3; }
        body { max-width: 100% !important; margin: 0; padding: 15px; width: 100%; box-sizing: border-box; }
        .header-container { text-align: center; padding: 1rem 0; }
        .company-logo { max-width: 180px; filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.1)); }
        .hidden { display: none; }
        .inventory-card { background: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 20px; width: 100%; box-sizing: border-box; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; width: 100%; }
        #add-btn { grid-column: 1 / -1; background-color: #28a745; color: white; padding: 12px; font-weight: bold; border: none; border-radius: 4px; }
        #inventory-list { overflow-x: auto; width: 100%; border: 1px solid #eee; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background-color: var(--brand-color); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="https://static.wixstatic.com/media/2dd834_86e3b8f7ade04bd180292345eea5a1c0~mv2.png" class="company-logo">
        <h1>Inventory Control</h1>
    </div>

    <div id="login-section" class="inventory-card">
        <h3>Two-Factor Authentication</h3>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="pin" placeholder="Access PIN">
        <input type="text" id="otpCode" placeholder="6-Digit Authenticator Code" maxlength="6">
        <button style="width: 100%;" onclick="doLogin()">Secure Login</button>
    </div>

    <div id="main-section" class="hidden">
        <div id="admin-controls" class="inventory-card" style="background: #f4f7f6;">
            <h3>Register New Item</h3>
            <div class="grid-container">
                <input type="text" id="itemName" placeholder="Item Name">
                <select id="itemCategory">
                    <option value="Storage">Storage</option>
                    <option value="Shipping">Shipping</option>
                    <option value="Quote">Quote</option>
                    <option value="Sale">Sale</option>
                </select>
                <input type="number" id="itemStock" placeholder="Stock Level">
                <input type="number" id="itemPrice" placeholder="Sale Price">
                <input type="number" id="itemCost" placeholder="Unit Cost">
                <select id="itemStatus">
                    <option value="Available">Available</option>
                    <option value="Low Stock">Low Stock</option>
                    <option value="Discontinued">Discontinued</option>
                </select>
                <input type="text" id="itemWeight" placeholder="Weight">
                <input type="text" id="itemSupplier" placeholder="Supplier">
                <button id="add-btn" onclick="addItem()">Add to Inventory</button>
            </div>
        </div>

        <div class="inventory-card">
            <div id="inventory-list"><p>Loading...</p></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyA-TjXiKdnS_NtqrieV1w4rZW8dWn-gzGhE8M3TNLsSqq8PpgN4-CsNyDybAqsJtC_ew/exec";
        let SESSION_TOKEN = null;
        let LOGGED_USER = "";

        async function apiRequest(action, payload = {}) {
            const auth = {
                username: LOGGED_USER || document.getElementById('username').value,
                token: SESSION_TOKEN,
                pin: SESSION_TOKEN ? null : document.getElementById('pin').value,
                otpCode: SESSION_TOKEN ? null : document.getElementById('otpCode').value
            };
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action, auth, payload })
            });
            return await response.json();
        }

        async function doLogin() {
            const res = await apiRequest("LOGIN");
            if (res.error) return alert(res.error);
            
            SESSION_TOKEN = res.token;
            LOGGED_USER = document.getElementById('username').value;
            
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            loadInventory();
        }

        async function loadInventory() {
            const data = await apiRequest("READ");
            if (data.error) return alert("Session Error: " + data.error);

            let html = `<table><tr><th>ID</th><th>Name</th><th>Category</th><th>Stock</th><th>Price</th><th>Cost</th><th>Status</th><th>Supplier</th><th>Action</th></tr>`;
            data.slice(1).forEach(row => {
                html += `<tr><td>${row[0]}</td><td><b>${row[1]}</b></td><td>${row[2]}</td><td>${row[3]}</td><td>$${row[4]}</td><td>$${row[5]}</td><td>${row[6]}</td><td>${row[8]}</td><td><button style="background:#ff4444;padding:5px;" onclick="deleteItem('${row[0]}')">Delete</button></td></tr>`;
            });
            document.getElementById('inventory-list').innerHTML = html + "</table>";
        }

        async function addItem() {
            const btn = document.querySelector("#add-btn");
            btn.disabled = true;
            btn.innerText = "Authorizing...";

            const payload = {
                name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                stock: document.getElementById('itemStock').value,
                price: document.getElementById('itemPrice').value,
                cost: document.getElementById('itemCost').value,
                status: document.getElementById('itemStatus').value,
                weight: document.getElementById('itemWeight').value,
                supplier: document.getElementById('itemSupplier').value
            };

            const res = await apiRequest("CREATE", payload);
            if (res.status === "Success") {
                alert("Item Added!");
                loadInventory();
                document.querySelectorAll("#admin-controls input").forEach(i => i.value = "");
            } else {
                alert("Error: " + res.error);
            }
            btn.disabled = false;
            btn.innerText = "Add to Inventory";
        }

        async function deleteItem(id) {
            if(confirm("Delete item?")) { 
                await apiRequest("DELETE", { id });
                loadInventory(); 
            }
        }
    </script>
</body>
</html>
