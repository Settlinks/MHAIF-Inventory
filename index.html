<script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw_SvBtgR6XcTrIy--Xq7LldypB-s0b9pNqc_ngsy7gsYWzndnV5MCqm8u2QXsB-_r4HQ/exec"; 

        async function apiRequest(action, payload = {}) {
            const userVal = document.getElementById('username').value;
            const pinVal = document.getElementById('pin').value;

            if (!userVal || !pinVal) {
                alert("Please enter both Username and PIN");
                return;
            }

            const auth = { username: userVal, pin: pinVal };
            
            try {
                // Using redirect: "follow" is key for Google Scripts
                const response = await fetch(API_URL, {
                    method: "POST",
                    mode: "cors", 
                    body: JSON.stringify({ action, auth, payload })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error:", error);
                return "Auth Error";
            }
        }

        async function loadInventory() {
            const inventoryDiv = document.getElementById('inventory-list');
            inventoryDiv.innerHTML = "<p>Loading inventory data...</p>";

            const data = await apiRequest("READ");
            
            if (data === "Auth Error" || typeof data === 'string') {
                alert("Access Denied: Check Username/PIN");
                return;
            }

            // Show main app, hide login
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('admin-controls').classList.remove('hidden');

            // Build Table
            let html = "<table><thead><tr><th>ID</th><th>Name</th><th>Stock</th><th>Action</th></tr></thead><tbody>";
            
            // data[0] is headers, so we start at index 1
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                html += `<tr>
                    <td>${row[0]}</td>
                    <td><strong>${row[1]}</strong></td>
                    <td>${row[3]}</td>
                    <td><button style="background: #ff4444; border-color: #ff4444;" onclick="deleteItem('${row[0]}')">Delete</button></td>
                </tr>`;
            }
            
            html += "</tbody></table>";
            inventoryDiv.innerHTML = data.length > 1 ? html : "<p>No items found in inventory.</p>";
        }

        async function addItem() {
            const nameInput = document.getElementById('itemName');
            const stockInput = document.getElementById('itemStock');
            const btn = document.querySelector("#admin-controls button");

            if (!nameInput.value || !stockInput.value) {
                alert("Please fill in Name and Stock");
                return;
            }

            btn.innerText = "Saving...";
            btn.disabled = true;

            await apiRequest("CREATE", { 
                name: nameInput.value, 
                category: "General", 
                stock: stockInput.value 
            });

            nameInput.value = "";
            stockInput.value = "";
            btn.innerText = "Add Item";
            btn.disabled = false;

            loadInventory(); // Refresh the list
        }

        async function deleteItem(id) {
            if(confirm("Permanently remove this item?")) {
                await apiRequest("DELETE", { id: id });
                loadInventory(); // Refresh the list
            }
        }
    </script>
</body>
</html>
